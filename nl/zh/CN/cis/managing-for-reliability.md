---
copyright:
  years: 2018
lastupdated: "2018-03-13"
---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}

# 管理 IBM CIS 部署以实现最佳可靠性

要实现 IBM CIS 部署的最佳可靠性，可以设置 DNS 配置，也可以设置全局负载均衡器。为获取额外的可靠性，可以使用“页面规则”来确保将 Web 内容发送给客户，即使源服务器或高速缓存有问题也可发送。本文档提供了有关确保 IBM CIS 部署最佳可靠性的一些最佳实践的详细信息。

通常，建议的最佳实践如下：

 * 设置 DNS 以利用 IBM CIS 代理服务器和其他功能
 * 使用一个或多个全局负载均衡器均匀分布站点流量
 * 设置适当的页面规则以管理高速缓存和其他选项

这些项中的每一项都提供了一些功能，可使用这些功能来创建更可靠的 CIS 部署。

请注意，将在*安全性*、*可靠性*和*性能*部分中组织 CIS 接口。下图中显示了主导航菜单，其中显示了全局负载均衡器和 DNS 菜单项：

![左侧导航 DNS](images/cis-left-navigation.png)


## 设置 DNS
 
 要开始设置 DNS 配置，请从导航菜单中选择 **DNS**，如上所示。
 
 有关设置和管理 DNS 以获得可靠性的详细信息，请[参阅此文档](dns.html#setting-up-your-domain-name-system-dns-for-ibm-cis)。


## 设置全局负载均衡器


要开始设置全局负载均衡器，请从导航菜单中选择**全局负载均衡器**。

有关设置和管理全局负载均衡器的详细信息，请[参阅此文档](glb.html#global-load-balancer-glb-concepts)。

## 使用“页面规则”提高可靠性

以下是一些建议的“页面规则”设置，可实现站点的最佳可靠性：

 * 始终联机
 * 源高速缓存控制
 * 转发 URL

 ## 始终联机

如果服务器宕机，可以使用**始终联机**页面规则设置，保持站点的有限版本联机。

通过**始终联机**，您的服务器关闭时，IBM 将从高速缓存中处理页面，因此您的访问者仍可以看到其正在尝试访问的某些页面。访问者将在页面顶部看到一条消息，指示其处于脱机浏览方式。“始终联机”返回 HTTP 状态码 503，但是，很多其他 Web 应用程序也使用 503。当您的服务器恢复联机状态时，IBM CIS 会将用户无缝切换回正常浏览。

如果 IBM CIS 在其高速缓存中没有所请求的页面，那么您的访客会看到错误页面，指示其正在请求的 Web 站点页面处于脱机状态。

### 如何设置“始终联机”

要启用**始终联机**，请执行以下步骤：

 * 使用导航菜单，在“性能”下选择“页面规则”。
 * 使用域的 URL 模式创建页面规则。
 * 添加开启了开关的**始终联机**设置。
 * 选择“供应资源”。

 ### “始终联机”的限制

 * **始终联机**会高速缓存根 HTML 中的前 10 个链接，然后仅高速缓存来自这些页面的每个页面的第一个链接，最后是来自这些后续页面中每个页面的第一个链接。这意味着，当您的源服务器关闭时，您站点上只有某些页面可供查看。

 * 最近添加的站点不会具有针对其站点的大量高速缓存，这意味着，对于在几天前添加的站点，**始终联机**可能不会生效。

 * 如果服务器宕机，那么 CIS 将无法显示私有内容或处理表单提交 (POST)。将在结帐页面或项上向访问者显示错误，指示需要登录才能查看。

 * 要触发**始终联机**, Web 服务器必须返回标准的 HTTP 错误代码 502 或 504 超时。在联系源遇到问题（错误 521 & 523）或者发生超时 (522 & 524)、SSL 错误 (525 & 526) 或未知错误 (520) 时，“始终联机”也会生效。针对其他 HTTP 响应代码（例如，404s、500 和 503）、数据库连接错误，内部服务器错误或服务器应答为空），不会触发**始终联机**。

 * 如果对“高速缓存所有内容”页面规则启用的“边缘高速缓存到期 TTL”低于高速缓存频率（免费客户为 7 天，专业客户为 3 天，企业客户为 1 天），那么**始终联机**将无效，因为“边缘高速缓存到期 TTL”会导致在相应的时间间隔中清除**始终联机**高速缓存。

## 源高速缓存控制

您可以使用**源高速缓存控制**页面规则设置，确定从源高速缓存的内容以及更新内容的频率，这会影响可靠性和性能。缺省情况下，如果未更改任何设置，并且未从源服务器发送任何阻止高速缓存的头，那么 IBM CIS 会使用某些扩展来高速缓存所有静态内容。这些类型的内容包括图像、CSS 和 JavaScript。此高速缓存主要用于提高性能。

要设置**源高速缓存控制**，可以使用“页面规则”来打开特定头，其中提供与内容的每个资源相关的所需行为。要了解如何使用**源高速缓存控制**，需要有关“页面规则”以及 CIS 的整体高速缓存行为的更全面说明以提供上下文，这将在接下来的几个部分中进行介绍。通常，可以使用三种方法来控制高速缓存，而**源高速缓存控制**是第二种方法。

设置**源高速缓存控制**会调用高速缓存规则，这些规则旨在严格遵守因特网最佳实践和 RFC，主要是在重新验证方面。例如，`max-age=0` 这一 CIS 缺省行为根本不会进行高速缓存，而设置**源高速缓存控制**则会高速缓存，但始终会重新验证。

### 如何设置源高速缓存控制

 * 使用导航菜单，在“性能”下选择“页面规则”。
 * 使用引用域的 URL 模式创建页面规则。
 * 添加开启了开关的**源高速缓存控制**设置。
 * 选择“供应资源”。

### 页面规则优先顺序

对于整个高速缓存，两个特定的页面规则优先：

 * 如果页面规则将**高速缓存级别**设置为`绕过`，那么不会高速缓存与该页面规则匹配的资源。IBM CIS 仍充当代理，而其他性能功能部件处于活动状态。但是，不会从高速缓存中处理您的内容，将直接从源服务器中访存这些内容。

 * 如果页面规则将**高速缓存级别**设置为`高速缓存所有内容`，那么会高速缓存与该页面规则匹配的资源。**使用此“页面规则”设置是能够高速缓存静态以及非静态资源（包括 HTML 在内）的唯一方法。**

如果未设置任何页面规则，将使用基于资源扩展的`标准`高速缓存方式。将仅对静态资源进行高速缓存（如上所述）。

### 源高速缓存控制头

改变 IBM CIS 高速缓存内容的第二种方法是高速缓存从源发送的头。CIS 将遵循这些设置，但您可以通过指定**边缘高速缓存 TTL** 页面规则设置来覆盖这些设置。以下是在决定从源缓存哪些资源时需要考虑的头：

 * 如果 **Cache-Control** 头设置为 `private`、`no-store`、`no-cache` 或 `max-age=0`，或者如果响应中存在 cookie ，那么 IBM CIS 不会对资源进行高速缓存。请注意，不应该高速缓存敏感材料，因此在此情况下，可能需要考虑使用其中一个头。

 * 如果 **Cache-Control** 头设置为 `public` 并且 `max-age` 大于 0，或者如果 `Expires` 头设置为将来任何时间，那么将高速缓存资源。

**注：**根据 RFC 规则，`Cache-Control: max-age` 优先于 `Expires` 头。如果同时看到这两者，并且不一致，那么 `max-age` 将优先。

### 使用“s-maxage”头

同时控制高速缓存行为和浏览器高速缓存行为的第三种方法是使用 `s-maxage`Cache-Control 头。

通常，遵循 `max-age` 指令：

`Cache-Control: max-age=1000`

但是，如果要指定不同于浏览器的高速缓存超时，可以使用 `s-maxage`。以下是一个示例，告知 IBM CIS 将对象高速缓存 200 秒，并告知浏览器将对象高速缓存 60 秒。

`Cache-Control: s-maxage=200, max-age=60`

通常，`s-maxage` 后面只跟逆向代理（因此，浏览器应该忽略它）；但是，如果存在 `s-maxage`，IBM CIS 会优先 s-maxage。对于以下两者，将采用值更大的设置：浏览器高速缓存设置或 `max-age` 头。

### 有关高速缓存控制头和页面规则的可靠性摘要

以下是对于高速缓存可靠性要考虑的一些主要方面的总结：

 * 检查源的高速缓存头，以确保不存在可高速缓存资源的覆盖头（`Cache-Control` 和 `Expires`）。

 * 缺省情况下，CIS 始终对静态内容进行高速缓存，并且根据返回码具有以下 TTL：

```
200 301    120m;
302 303    20m;
403        5m; for reliability
404        5m;
any        0s;
```

 * 要对更多内容进行高速缓存，请针对所需 URL 创建将**高速缓存级别**设置为“高速缓存所有内容”的页面规则，如果请求此 URL 时 Web 服务器返回 404，那么会仅高速缓存此结果 5 分钟）。

 * 要避免对 URL 进行高速缓存，请创建将**高速缓存级别**设置为“绕过”的页面规则。


 ## 转发 URL

要确保您的内容始终可用 (HA)，可以创建带有**转发 URL** 设置的页面规则，以便在您的站点不可用时使用。

 **注：**启用**转发 URL** 时，会禁用所有其他设置，因为这会将所有流量发送到其他 URL。

### 如何设置转发 URL

 * 使用导航菜单，在“性能”下选择“页面规则”。
 * 使用引用域的 URL 模式创建页面规则。
 * 添加**转发 URL** 设置。
 * 选择转发类型并输入目标 URL。
 * 选择“供应资源”。

### 转发示例：

想象一下，您希望使任何人都可以轻松访问 URL，例如：

    *www.example.com/+

    *example.com/+

此模式将匹配：

    http://example.com/+
    http://www.example.com/+
    https://www.example.com/+
    https://blog.example.com/+
    https://www.blog.example.com/+
    Etc...

它将不匹配：

    http://www.example.com/blog/+  [extra directory before the +]
    http://www.example.com+  [no trailing slash]


一旦创建了与所需内容匹配的模式，请添加**转发 URL** 设置并选择转发类型，然后输入目标 URL。例如：


    https://plus.google.com/yourid

选择“供应资源”。在几秒钟内，与该模式匹配的任何请求都将转发到具有指定重定向的新 URL。

### 高级转发选项：

如果使用基本重定向（例如，将根域转发到 www.yourdomain.com），那么 URL 中的其他内容都将丢失。例如，可以设置模式：

    example.com

并将其转发至：

    http://www.example.com

但是，如果某位用户输入了以下内容：

    example.com/some-particular-page.html

那么会将其重定向到：

    www.example.com

而不是

    www.example.com/some-particular-page.html

解决方案是使用变量。每个通配符与可在转发地址中引用的变量对应。变量由 `$` 后跟一个数字表示。要引用第一个通配符，将使用 `$1`，要引用第二个通配符，将使用 `$2`，依此类推。要修正上一示例中的 root 用户到 `www` 的转发，可以使用相同的模式：

    example.com/*

然后设置以下 URL 以将流量转发至：

    http://www.example.com/$1

在此情况下，如果某位用户访问：

    example.com/some-particular-page.html

那么会将其重定向到：

    http://www.example.com/some-particular-page.html

---
copyright:
  years: 2018
lastupdated: "2018-03-13"
---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}

# 最適な信頼性を確保するための IBM CIS デプロイメントの管理

IBM CIS デプロイメントの信頼性を最適化するために、便利な DNS 構成やグローバル・ロード・バランサーをセットアップできます。信頼性をさらに高めるために、ページ・ルールを使用することも可能です。そうすれば、起点サーバーやキャッシュに問題があっても、Web コンテンツを顧客に確実に配信できます。この資料では、IBM CIS デプロイメントの信頼性を最適化するためのベスト・プラクティスの詳細情報を取り上げます。

弊社で推奨している一般的なベスト・プラクティスは以下のとおりです。

 * DNS をセットアップして、IBM CIS のプロキシー・サーバーや他の機能を活用します。
 * 1 つ以上のグローバル・ロード・バランサーを使用して、サイトのトラフィックを均等に分散させます。
 * ページ・ルールをセットアップして、キャッシングなどのオプションを管理します。

それぞれの項目に、信頼性の高い CIS デプロイメントを作成するための機能が含まれています。

CIS インターフェースは、*セキュリティー*、*信頼性*、*パフォーマンス*というセクションに編成されています。以下の図はメインのナビゲーション・メニューです。グローバル・ロード・バランサーと DNS のメニュー項目が表示されています。

![左側のナビゲーション、DNS ](images/cis-left-navigation.png)


## DNS のセットアップ
 
 DNS 構成のセットアップを始めるために、前の図にあるとおり、ナビゲーション・メニューから**「DNS」**を選択します。
 
 信頼性を高めるための DNS のセットアップと管理の詳細については、[この資料を参照](dns.html#setting-up-your-domain-name-system-dns-for-ibm-cis)してください。


## グローバル・ロード・バランサーのセットアップ


グローバル・ロード・バランサーのセットアップを始めるために、ナビゲーション・メニューから**「グローバル・ロード・バランサー」**を選択します。

グローバル・ロード・バランサーのセットアップと管理の詳細については、[この資料を参照](glb.html#global-load-balancer-glb-concepts)してください。

## ページ・ルールを使用して信頼性を高める方法

サイトの信頼性を最大化するための推奨ページ・ルール設定を以下にまとめます。

 * 常にオンライン (Always Online)
 * 起点キャッシュ制御 (Origin Cache Control)
 * 転送用 URL (Forwarding URL)

 ## 常にオンライン (Always Online)

**「常にオンライン (Always Online)」**ページ・ルール設定を使用すれば、サーバーがダウンした時でもサイトの限定バージョンをオンラインにしておけます。

**「常にオンライン (Always Online)」**にしておくと、サーバーがダウンしても、IBM CIS のキャッシュからページが提供されるので、訪問者は、アクセスするページを一部だけでも表示できるようになります。ページの上部に、オフライン表示モードになっているという趣旨の訪問者向けのメッセージが表示されます。「常にオンライン (Always Online)」では HTTP 状況 503 が返されますが、503 は他の多くの Web アプリケーションでも使用されています。サーバーがオンライン状態に戻ると、IBM CIS ユーザーの表示モードが通常モードにシームレスに切り替わります。

要求対象のページが IBM CIS のキャッシュに入っていない場合は、その Web サイト・ページがオフラインになっているという趣旨のエラー・ページが訪問者に表示されます。

### 「常にオンライン (Always Online)」のセットアップ方法

**「常にオンライン (Always Online)」**を有効にするには、以下の手順を実行します。

 * ナビゲーション・メニューで「パフォーマンス」の下にある「ページ・ルール」を選択します。
 * ドメインの URL パターンを使用してページ・ルールを作成します。
 * **「常にオンライン (Always Online)」**設定を追加してオンに切り替えます。
 * 「リソースのプロビジョン (Provision Resource)」を選択します。

 ### 「常にオンライン (Always Online)」の制約

 * **「常にオンライン (Always Online)」**の設定では、ルート HTML からの最初の 10 のリンク、そのリンク先ページからの最初のいくつかのリンク、そのまたリンク先ページからの最初のいくつかのリンクがキャッシュに入ります。したがって、起点サーバーがダウンした時に表示可能になるのは、サイトのごく一部のページだけになります。

 * 追加したばかりのサイトには、サイトを利用するための大きなキャッシュがないので、数日前に追加したばかりのサイトでは、**「常にオンライン (Always Online)」**が正常に機能しない場合があります。

 * CIS では、サーバーがダウンすると、プライベート・コンテンツやハンドル・フォーム送信 (POST) を表示できなくなります。チェックアウト・ページや、閲覧のためにログインが必要な項目では、訪問者にエラーが表示されます。

 * **「常にオンライン (Always Online)」**を起動するには、Web サーバーが 502 や 504 のタイムアウトに関する標準 HTTP エラー・コードを返すことが必要です。「常にオンライン (Always Online)」は、起点へのアクセス (エラー 521 & 523)、タイムアウト (522 & 524)、SSL エラー (525 & 526)、不明エラー (520) の問題が発生した場合にも機能します。**「常にオンライン (Always Online)」**は、他の HTTP 応答コード (404、500、503、データベース接続エラー、内部サーバー・エラー、サーバーからの空の応答など) では起動しません。

 * 「すべてキャッシュ (Cache Everything)」ページ・ルールが有効になっていて、「エッジ・キャッシュ有効期限 TTL (Edge Cache Expire TTL)」がキャッシング頻度 (フリーのお客様: 7 日、プロのお客様: 3 日間、ビジネスとエンタープライズのお客様: 1 日) よりも小さい値になっていると、**「常にオンライン (Always Online)」**は機能しません。**「常にオンライン (Always Online)」**のキャッシュの内容は、「エッジ・キャッシュ有効期限 TTL (Edge Cache Expire TTL)」に対応する間隔で消去されるからです。

## 起点キャッシュ制御 (Origin Cache Control)

**「起点キャッシュ制御 (Origin Cache Control)」**ページ・ルール設定を使用して、起点からキャッシュに入れるコンテンツの種類やコンテンツの更新頻度を指定できます。こうした設定は、信頼性とパフォーマンスに影響を与えます。設定を変更せずに、キャッシングを禁止するヘッダーを起点サーバーから送信しなければ、デフォルトでは、IBM CIS のキャッシュにすべての静的コンテンツと一部の拡張子のコンテンツが入るようになります。該当するのは、画像、CSS、JavaScript などのタイプのコンテンツです。このようなキャッシングを行うのは、主にパフォーマンス上の理由によります。

**「起点キャッシュ制御 (Origin Cache Control)」**をセットアップするには、ページ・ルールを使用して、コンテンツのリソースごとに望ましい動作を指定した該当ヘッダーをオンにします。**「起点キャッシュ制御 (Origin Cache Control)」**の使用方法を理解するには、CIS のページ・ルールとキャッシング動作全体をコンテキストに沿って取り上げた一般的な説明が必要です。この後のいくつかのセクションでそのような説明を確認してください。一般的に言えば、キャッシングを制御するには 3 つの方法があり、**「起点キャッシュ制御 (Origin Cache Control)」**は、そのうちの 2 番目です。

**「起点キャッシュ制御 (Origin Cache Control)」**を設定すると、主に再検証に関連したインターネット・ベスト・プラクティスと RFC にできるだけ準拠したキャッシング・ルールが起動します。例えば、CIS の `max-age=0` のデフォルトの動作では、何もキャッシュに入りませんが、**「起点キャッシュ制御 (Origin Cache Control)」**の設定では、常に再検証を前提としてキャッシュにデータが入るようになります。

### 「起点キャッシュ制御 (Origin Cache Control)」のセットアップ方法

 * ナビゲーション・メニューで「パフォーマンス」の下にある「ページ・ルール」を選択します。
 * ドメインを参照する URL パターンを使用してページ・ルールを作成します。
 * **「起点キャッシュ制御 (Origin Cache Control)」**設定を追加してオンに切り替えます。
 * 「リソースのプロビジョン (Provision Resource)」を選択します。

### ページ・ルールの優先順位

キャッシング全体で優先されるページ・ルールが 2 つあります。

 * ページ・ルールで**「キャッシュ・レベル」**を`「バイパス (Bypass)」`に設定すると、そのページ・ルールに合致するリソースはキャッシュに入らなくなります。その場合も IBM CIS はプロキシーとして機能し、他のパフォーマンス機能もアクティブのままになります。しかし、コンテンツはキャッシュから提供されず、起点サーバーから直接取り出されます。

 * ページ・ルールで**「キャッシュ・レベル」**を`「すべてキャッシュ (Cache everything)」`に設定すると、そのページ・ルールに合致するリソースはすべてキャッシュに入ります。**静的コンテンツと見なされるリソース以外のリソース (HTML など) をキャッシュに入れるには、このページ・ルール設定を使用するしか方法がありません。**

ページ・ルールを設定しない場合は、リソースの拡張子に基づく`標準`キャッシング・モードが使用されます。その場合は、静的リソースだけがキャッシュに入ります (前述のとおりです)。

### 起点の Cache-Control ヘッダー

IBM CIS のキャッシュの動作を変更する 2 番目の方法は、起点から特定のヘッダーを送信するという方法です。CIS ではその設定が使用されますが、**「エッジ・キャッシュの TTL (Edge Cache TTL)」**ページ・ルール設定を指定してオーバーライドすることも可能です。起点からキャッシュに入れるリソースの種類を指定するためのヘッダーを以下にまとめます。

 * **Cache-Control** ヘッダーを、`private`、`no-store`、`no-cache`、`max-age=0` のいずれかに設定した場合や、応答に Cookie がない場合は、IBM CIS のキャッシュにリソースが入りません。機密性の高い資料をキャッシュに入れるべきではないので、そのような場合はこうしたヘッダーを使用できます。

 * **Cache-Control** ヘッダーを `public` に設定し、`max-age` を 0 より大きい値に設定した場合や、`Expires` ヘッダーを将来の任意の時刻に設定した場合は、そのリソースがキャッシュに入ります。

**注:** RFC のルールでは、`Cache-Control: max-age` のほうが `Expires` ヘッダーよりも優先されます。両方が存在し、整合していない場合は、`max-age` のほうが優先されます。

### s-maxage ヘッダーの使用

3 番目の方法では、`s-maxage` Cache-Control ヘッダーを使用してキャッシングの動作とブラウザー・キャッシュの動作を一緒に制御できます。

通常は、`max-age` ディレクティブが使用されます。

`Cache-Control: max-age=1000`

しかし、ブラウザーとは違うキャッシュ・タイムアウトを指定したい場合は、`s-maxage` を使用できます。同じオブジェクトのキャッシュのタイムアウトを、IBM CIS では 200 秒、ブラウザーでは 60 秒に設定する例を以下に示します。

`Cache-Control: s-maxage=200, max-age=60`

基本的に、`s-maxage` を使用するのはリバース・プロキシーだけであり、ブラウザーはその設定を無視します。一方、IBM CIS では、`s-maxage` があれば、その設定の方を優先します。ブラウザー・キャッシュ設定と `max-age` ヘッダーを比較して、大きいほうの値を使用します。

### 信頼性を高めるためのキャッシュ制御ヘッダーとページ・ルールのまとめ

キャッシングに関して信頼性を高める時に検討すべき主な分野を以下にまとめます。

 * 起点のキャッシング・ヘッダーをチェックして、キャッシュ可能なリソースの優先ヘッダー (`Cache-Control` と `Expires`) がないかどうかを確認します。

 * CIS では、デフォルトで常に静的コンテンツがキャッシュに入ります。戻りコードごとの TTL は以下のとおりです。

```
200 301    120m;
302 303    20m;
403        5m; (信頼性のため)
404        5m;
any        0s;
```

 * さらに多くのリソースをキャッシュに入れる場合は、対象の URL の**「キャッシュ・レベル」**を「すべてキャッシュ (Cache everything)」に設定したページ・ルールを作成します (その URL の要求時に Web サーバーから 404 が返されると、その結果が 5m だけキャッシュに入ります)。

 * URL でのキャッシングを避ける場合は、**「キャッシュ・レベル」**を「バイパス (Bypass)」に設定したページ・ルールを作成します。


 ## 転送用 URL (Forwarding URL)

コンテンツを常に利用できるようにする HA 構成のために、サイトが使用不可の状態になった時に使用する**「転送用 URL (Forwarding URL)」**設定を組み込んだページ・ルールを作成できます。

 **注:** **「転送用 URL (Forwarding URL)」**を有効にすると、他のすべての設定が無効になります。すべてのトラフィックを別の URL に送信することになるからです。

### 「転送用 URL (Forwarding URL)」のセットアップ方法

 * ナビゲーション・メニューで「パフォーマンス」の下にある「ページ・ルール」を選択します。
 * ドメインを参照する URL パターンを使用してページ・ルールを作成します。
 * **「転送用 URL (Forwarding URL)」**設定を追加します。
 * 転送のタイプを選択し、宛先の URL を入力します。
 * 「リソースのプロビジョン (Provision Resource)」を選択します。

### 転送の例:

訪問者を以下の URL に簡単に誘導するための方法を取り上げます。

    *www.example.com/+

    *example.com/+

このパターンに合致するのは、以下のようなサイトです。

    http://example.com/+
    http://www.example.com/+
    https://www.example.com/+
    https://blog.example.com/+
    https://www.blog.example.com/+
    など...

以下のようなサイトは合致しません。

    http://www.example.com/blog/+  [+ の前に余分のディレクトリーがある]
    http://www.example.com+  [末尾のスラッシュがない]


該当するマッチング・パターンを作成したら、**「転送用 URL (Forwarding URL)」**設定を追加し、転送のタイプを選択し、宛先の URL を入力します。例えば次のようにします。

    https://plus.google.com/yourid

「リソースのプロビジョン (Provision Resource)」を選択します。数秒すると、リダイレクト指定に基づいて、そのパターンに合致する要求が新しい URL に転送されるようになります。

### 拡張転送オプション:

ルート・ドメインを www.yourdomain.com に転送するといった基本的なリダイレクトでは、URL に含まれている他の要素が失われます。例えば、以下のパターンをセットアップするとします。

    example.com

転送先は以下のとおりです。

    http://www.example.com

しかし、以下の指定の場合はどうなるでしょうか。

    example.com/some-particular-page.html

リダイレクト先はこうなります。

    www.example.com

以下のページではありません。

    www.example.com/some-particular-page.html

解決策は、変数を使用することです。それぞれのワイルドカードが、転送用アドレスで参照できる変数に対応します。変数は、`$` の後に数字を付けた形式で表記します。最初のワイルドカードを参照する場合は `$1` を使用し、2 番目のワイルドカードを参照する場合は `$2` を使用する、といった具合です。前の例のような、ルートから `www` への転送を修正する場合も、同じパターンを使用できます。

    example.com/*

ただし、トラフィックの転送先 URL を以下のようにセットアップします。

    http://www.example.com/$1

その場合、アクセス先が以下のページだとしましょう。

    example.com/some-particular-page.html

リダイレクト先はこうなります。

    http://www.example.com/some-particular-page.html
